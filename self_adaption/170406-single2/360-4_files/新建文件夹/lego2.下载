/* 2016-10-20 11:46:15 landing/luckycat/order 0.0.18  */
define("landing/luckycat/order",["teemo","address"],function(e,t){return{filter:["userName","cellphone","location"],NodeIDs:["product","props","customer","count","total","phone","get","show","code","address","book"],Nodes:{},initNodes:function(){var e=this;$.each(e.NodeIDs,function(t,o){e.Nodes[o]=e.el.find("#"+o)})},fill:function(e){if(void 0!==e){var t=this;$.each(t.filter,function(o,n){var a=t.el.find("input[name="+n+"]");a&&a.val(e[n])})}},tariff:function(){var e=this,t=window.config.skus,o=0,n=null,a=$.grep(this.commonData,function(e){return"landing/luckycat/item"===e.name}).pop();a&&(o=a.price?a.price:0,n=a.promote?a.promote:null);var i=window.config.props;e.index=window.config.index,e.props=$.map(i,function(e){return{propName:e.propName,selected:!1}});var s=e.Nodes.count,i=e.Nodes.props;e.Nodes.total.find("#instock em").html(n?parseFloat(n).toFixed(2):parseFloat(o).toFixed(2)),e.allow=!window.config.props.length,e.skuId=-1,s.on("change",function(){i.trigger("click")}),i.on("click",function(){var a="",i=[];$(this).find(".row").each(function(t,o){var n=!1,a="",s="";$(o).find("input").each(function(e,t){n=n||!!t.checked,t.checked&&(a=$(t).attr("name"),s=t.value)}),e.props[t].selected=n,i.push([a,s].join(":"))}),a=i.join(";");var l=s.val(),r=$.grep(t,function(e){return e.ppath===a});r.length?(r=r.shift(),e.skuId=r.skuId,r.flags.stock?(e.Nodes.total.find("#outstock").hide(),e.Nodes.total.find("#instock em").html(parseFloat(parseFloat(r.price)*l).toFixed(2)),e.Nodes.total.find("#instock").show(),e.allow=!0):(e.Nodes.total.find("#instock").hide(),e.Nodes.total.find("#outstock").show(),e.allow=!1)):(e.Nodes.total.find("#outstock").hide(),e.Nodes.total.find("#instock em").html(parseFloat((n?n:o)*l).toFixed(2)),e.Nodes.total.find("#instock").show(),e.allow=!0,e.skuId=-1)})},site:function(e){this.address=new t(this.Nodes.address,{province:".selector .provinceList",city:".selector .cityList",zone:".selector  .zoneList"},e)},verify:function(){this.msv&&(this.gained=!1,this.countdown=60,this._demand())},_demand:function(){var e=this,t=null,o=e.Nodes.show,n=e.Nodes.get;n.on("click",function(){if(t)return null;var a=e.Nodes.phone.val();return a.length?/^1\d{10}$/.test(a)?(e.gained=!0,n.css("color","#b5b5b5"),n.text("重新获取("+e.countdown+"s)"),o.css("display","block"),t=setInterval(function(){e.countdown?(e.countdown--,n.text("重新获取("+e.countdown+"s)")):(clearInterval(t),n.removeAttr("style"),n.text("获取验证码"),e.countdown=60,t=null)},1e3),void $.ajax({type:"GET",url:"//dcfront.taobao.com/data.htm?api=mvcs",dataType:"jsonp",data:{o:"jsonp",cellphone:a}})):(alert("请输入正确的手机号!"),null):(alert("请输入手机号，再获取验证码!"),null)})},order:function(){var e=this;e.Nodes.book.on("click",function(){return e._inspect()?e.allow?void(e.msv?$.ajax({type:"GET",url:"//dcfront.taobao.com/data.htm?api=acvs",dataType:"jsonp",data:{o:"jsonp",cellphone:e.Nodes.phone.val(),code:e.Nodes.code.val(),sid:+new Date+""+Math.floor(3e10*Math.random())},success:function(t){200==t.code?(e._localStore(),e._add(),e.Nodes.customer.submit()):500==t.code&&alert(t.msg)},error:function(e,t,o){alert("提交失败，请检查您的网络再次尝试!")}}):(e._localStore(),e._add(),e.Nodes.customer.submit())):(alert("商品无货，无法下单"),null):null})},_inspect:function(){var e=this;if(!e._inspectProps())return!1;if(!e._inspectCustomer())return!1;var t=e.Nodes.phone.val();return!!/^1\d{10}$/.test(t)||(alert("请输入正确的手机号!"),!1)},_inspectProps:function(){var e=this,t=!0,o=$.grep(e.props,function(e){return!e.selected});return o.length&&(alert("请选择"+o.shift().propName+"!"),t=!1),t},_inspectCustomer:function(){var e=this,t={1:"请选择地区!",2:"请选择城市!",3:"请选择省份!",userName:"请填写姓名!",cellphone:"请填写手机号!",code_0:"请获取短息验证码!",code_1:"请输入短信验证码，三分钟内有效!",location:"请填写详细地址!"},o=$.grep(e.Nodes.customer.serializeArray(),function(e){return"tip"!==e.name&&0===e.value.length}),n=$.grep(e.address.state.location,function(e){return 0===e.length});if(o.length)if(1===o.length&&"location"===o[0].name&&n.length)alert(t[n.length]);else{var a=o[0];"code"===a.name?alert(t[a.name+(e.gained?"_1":"_0")]):alert(t[a.name])}else n.length&&alert(t[n.length]);return!(o.length||n.length)},_localStore:function(){var e=this,t={filled:{},selected:e.address.state.location};$.each(e.Nodes.customer.serializeArray(),function(o,n){$.inArray(n.name,e.filter)>-1&&(t.filled[n.name]=n.value)}),window.localStorage.setItem("_cache_",JSON.stringify(t))},_add:function(){var e=this,t={};$.each(e.Nodes.product.serializeArray(),function(e,o){t[o.name]=o.value});var o=($.grep(this.commonData,function(e){return"landing/luckycat/item"===e.name}).pop(),[{name:"jsToken",value:pointman.getConfig().token},{name:"api",value:"book"},{name:"city",value:e.address.state.location.join(",")},{name:"count",value:e.Nodes.count.val()},{name:"index",value:e.index},{name:"skuId",value:e.skuId},{name:"sid",value:+new Date+""+Math.floor(3e10*Math.random())}]),n=window.location.search.slice(1);n=n.split("&"),n=$.map(n,function(e){return{key:e.split("=")[0],value:e.split("=")[1]}}),$.each(n,function(e,t){"ali_trackid"===t.key?o.push({name:"alitrack",value:t.value}):"dpd"===t.key&&o.push({name:"dpd",value:t.value})});var a="";$.each(o,function(e,t){a+="<input class='hidden' name='"+t.name+"' value='"+t.value+"' />"}),e.Nodes.customer.append(a)},render:function(e){this.el=$(e),this.commonData=window.page.commonData||[],this.msv=!1;var t=$.parseJSON(window.localStorage.getItem("_cache_"));this.initNodes(),this.fill(t?t.filled:void 0),this.tariff(),this.site(t?t.selected:void 0),this.verify(),this.order()},destroy:function(){}}});